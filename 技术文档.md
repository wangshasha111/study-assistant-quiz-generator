# 🔧 Study Assistant - 技术文档

## 📋 目录
1. [系统架构](#系统架构)
2. [安装配置](#安装配置)
3. [开发指南](#开发指南)
4. [数据库管理](#数据库管理)
5. [故障排除](#故障排除)
6. [版本兼容性](#版本兼容性)

---

## 🏗️ 系统架构

### 核心组件

```
project_study_assistant_quiz_generation/
├── app.py                      # 主应用程序
├── database.py                 # 数据库管理
├── session_utils.py            # 会话工具
├── admin_auth.py               # 管理员认证
├── pages/
│   └── 1_📊_Admin_Dashboard.py # 管理员面板
├── venv/                       # 虚拟环境
├── study_assistant.db          # SQLite 数据库
├── .env                        # 环境变量配置
└── requirements.txt            # 依赖列表
```

### 技术栈

| 组件 | 技术 | 版本 |
|------|------|------|
| Web 框架 | Streamlit | 1.29.0+ |
| AI 框架 | LangChain | 0.1.0+ |
| LLM API | OpenAI | 1.109.1+ |
| PDF 处理 | PyPDF2 | 3.0.1+ |
| PDF 生成 | ReportLab | 4.4.4+ |
| 数据库 | SQLite3 | 内置 |
| 环境变量 | python-dotenv | 1.0.0+ |

### 数据流

```
用户输入 → PDF提取/文本输入 → LangChain处理 
    ↓
OpenAI API (GPT模型)
    ↓
生成摘要 + 测验 → 显示结果 → 数据库记录
    ↓
用户互动 → 提交答案 → 评分 → 下载PDF/TXT
```

---

## 💻 安装配置

### 系统要求

- **操作系统**: macOS / Linux / Windows
- **Python**: 3.8 或更高版本
- **内存**: 最少 512MB
- **磁盘**: 最少 500MB

### 初始安装

```bash
# 1. 克隆或下载项目
cd project_study_assistant_quiz_generation

# 2. 创建虚拟环境
python3 -m venv venv

# 3. 激活虚拟环境
source venv/bin/activate  # macOS/Linux
# 或
venv\Scripts\activate     # Windows

# 4. 升级 pip
pip install --upgrade pip

# 5. 安装依赖
pip install -r requirements.txt

# 6. 配置环境变量
cp .env.example .env
nano .env  # 编辑配置

# 7. 启动应用
streamlit run app.py
```

### 环境变量配置

创建 `.env` 文件：

```bash
# OpenAI API Key (可选，可在应用中输入)
OPENAI_API_KEY=sk-your-api-key-here

# 管理员密码 (必需，启用 Admin Dashboard)
ADMIN_PASSWORD=your_secure_password
```

### 验证安装

```bash
# 测试 Python 版本
python3 --version

# 测试关键包
python3 -c "import streamlit; print('✓ Streamlit')"
python3 -c "import langchain; print('✓ LangChain')"
python3 -c "import openai; print('✓ OpenAI')"
python3 -c "import PyPDF2; print('✓ PyPDF2')"
python3 -c "import reportlab; print('✓ ReportLab')"

# 测试配置
python3 test_admin_config.py
```

---

## 👨‍💻 开发指南

### 项目结构详解

#### app.py (主应用，~1424行)
- **功能**: 主用户界面和核心逻辑
- **关键函数**:
  - `extract_text_from_pdf()`: PDF 文本提取
  - `summarize_content()`: 生成摘要
  - `generate_quiz_questions()`: 生成测验
  - `display_interactive_quiz()`: 交互式测验
  - `generate_pdf_with_results()`: PDF 生成
- **特性**:
  - LangChain LCEL 模式
  - 会话状态管理
  - 调试模式支持
  - 数据库集成

#### database.py (~350行)
- **功能**: SQLite 数据库管理
- **类**: `DatabaseManager`
- **表结构**:
  ```sql
  sessions (
    session_id TEXT PRIMARY KEY,
    username TEXT,
    ip_address TEXT,
    user_agent TEXT,
    created_at TIMESTAMP,
    last_activity TIMESTAMP
  )
  
  generations (
    id INTEGER PRIMARY KEY,
    session_id TEXT,
    timestamp TIMESTAMP,
    file_name TEXT,
    file_size INTEGER,
    content_length INTEGER,
    input_method TEXT,
    summary TEXT,
    quiz TEXT,
    model_used TEXT,
    debug_mode BOOLEAN
  )
  
  quiz_results (
    id INTEGER PRIMARY KEY,
    session_id TEXT,
    generation_id INTEGER,
    score INTEGER,
    total_questions INTEGER,
    percentage REAL,
    answered_count INTEGER,
    user_answers TEXT,  -- JSON
    completed_at TIMESTAMP
  )
  ```

#### session_utils.py (~70行)
- **功能**: 会话跟踪工具
- **函数**:
  - `get_session_id()`: 获取 Streamlit 会话 ID
  - `get_client_ip()`: 获取客户端 IP（支持代理）
  - `get_user_agent()`: 获取浏览器信息
  - `format_file_size()`: 格式化文件大小
  - `truncate_text()`: 截断长文本

#### admin_auth.py (~120行)
- **功能**: 管理员认证
- **函数**:
  - `get_admin_password()`: 获取管理员密码
  - `is_admin_enabled()`: 检查是否启用管理功能
  - `check_admin_authentication()`: 认证检查
  - `logout_admin()`: 登出
  - `show_logout_button()`: 显示登出按钮

### LangChain 集成

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import StrOutputParser

# 初始化 LLM
llm = ChatOpenAI(
    model_name="gpt-3.5-turbo",
    temperature=0.7,
    openai_api_key=api_key
)

# 创建提示模板
prompt = PromptTemplate(
    input_variables=["content"],
    template="..."
)

# LCEL 链式调用
chain = prompt | llm | StrOutputParser()
result = chain.invoke({"content": content})
```

### 添加新功能

#### 示例：添加新的测验类型

1. **修改提示模板** (`app.py`)
```python
def generate_true_false_quiz(llm, content: str) -> str:
    quiz_template = """Generate True/False questions..."""
    # 实现逻辑
```

2. **更新 UI** (`app.py`)
```python
quiz_type = st.selectbox("Quiz Type", ["Multiple Choice", "True/False"])
if quiz_type == "True/False":
    quiz = generate_true_false_quiz(llm, content)
```

3. **更新数据库** (如需要)
```python
# 添加新字段到 generations 表
ALTER TABLE generations ADD COLUMN quiz_type TEXT;
```

### 调试技巧

```python
# 1. 启用 Streamlit 调试模式
streamlit run app.py --logger.level=debug

# 2. 添加日志
import logging
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)
logger.debug("Debug message")

# 3. 使用 st.write() 调试
st.write("Debug:", variable)

# 4. 检查会话状态
st.write(st.session_state)

# 5. 异常处理
try:
    # 代码
except Exception as e:
    st.error(f"Error: {e}")
    import traceback
    st.code(traceback.format_exc())
```

---

## 🗄️ 数据库管理

### 查看数据

```bash
# 使用 sqlite3
sqlite3 study_assistant.db

# SQL 查询
.tables
SELECT * FROM sessions LIMIT 10;
SELECT * FROM generations WHERE debug_mode = 0;
SELECT * FROM quiz_results ORDER BY percentage DESC;
.quit
```

### 备份数据库

```bash
# 创建备份
cp study_assistant.db study_assistant_backup_$(date +%Y%m%d).db

# 或使用 SQLite 命令
sqlite3 study_assistant.db ".backup study_assistant_backup.db"
```

### 重置数据库

```bash
# 删除数据库（会丢失所有数据）
rm study_assistant.db

# 重启应用，数据库会自动重新创建
streamlit run app.py
```

### 导出数据

```python
# 使用 DatabaseManager
from database import DatabaseManager

db = DatabaseManager()

# 导出会话数据
db.export_session_data(session_id, "output.json")

# 获取统计信息
stats = db.get_statistics()
print(stats)
```

---

## 🔧 故障排除

### 常见错误及解决

#### 1. ModuleNotFoundError

```bash
# 症状
ModuleNotFoundError: No module named 'reportlab'

# 解决
source venv/bin/activate
pip install -r requirements.txt
```

#### 2. TypeError: width parameter

```bash
# 症状
TypeError: 'str' object cannot be interpreted as an integer

# 原因
Streamlit 1.29.0 不支持 width="stretch"

# 解决
已修复，使用 use_container_width=True
```

#### 3. 数据库锁定

```bash
# 症状
sqlite3.OperationalError: database is locked

# 解决
# 停止所有 Streamlit 实例
killall streamlit
# 重新启动
streamlit run app.py
```

#### 4. 端口占用

```bash
# 症状
Address already in use

# 解决方案 1
lsof -ti:8501 | xargs kill -9

# 解决方案 2
streamlit run app.py --server.port 8502
```

#### 5. OpenAI API 错误

```bash
# 症状
openai.error.AuthenticationError

# 解决
# 1. 使用调试模式测试
# 2. 验证 API Key
# 3. 检查账户余额
```

### 完全重置

```bash
# 停止应用
killall streamlit

# 删除虚拟环境
rm -rf venv

# 删除缓存
find . -type d -name __pycache__ -exec rm -rf {} +

# 删除数据库（可选）
rm study_assistant.db

# 重新安装
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 重新启动
streamlit run app.py
```

---

## 📦 版本兼容性

### 当前版本

```
Python: 3.12
Streamlit: 1.29.0
LangChain: 0.1.0
langchain-openai: 0.0.6
OpenAI: 1.109.1
PyPDF2: 3.0.1
ReportLab: 4.4.4
python-dotenv: 1.0.0
```

### API 变更历史

#### Streamlit API 变更

**1.29.0** (当前)
- 使用 `use_container_width=True`
- 使用 `st.context.headers` (新版本)
- 向后兼容 `_get_websocket_headers()`

**1.37.0+** (未来)
- 支持 `width="stretch"` 参数
- 新的布局组件

### 升级指南

```bash
# 检查当前版本
pip list | grep streamlit

# 升级单个包
pip install --upgrade streamlit

# 升级所有包
pip install --upgrade -r requirements.txt

# 锁定版本（生产环境推荐）
pip freeze > requirements-lock.txt
```

### 兼容性检查

```bash
# 测试所有导入
python3 << EOF
import streamlit
import langchain
import openai
import PyPDF2
import reportlab
print("✓ All imports successful")
EOF

# 运行测试
python3 test_admin_config.py

# 语法检查
python3 -m py_compile app.py
```

---

## 🚀 部署指南

### 本地部署

```bash
# 使用 run.command（macOS）
./run.command

# 或手动启动
source venv/bin/activate
streamlit run app.py
```

### 服务器部署

```bash
# 后台运行
nohup streamlit run app.py --server.headless true &

# 使用指定端口
streamlit run app.py --server.port 8080 --server.address 0.0.0.0
```

### Docker 部署（可选）

```dockerfile
FROM python:3.12-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

ENV ADMIN_PASSWORD=change_me_in_production

EXPOSE 8501

CMD ["streamlit", "run", "app.py", "--server.headless", "true"]
```

### Streamlit Cloud 部署

1. 推送代码到 GitHub
2. 访问 share.streamlit.io
3. 连接 GitHub 仓库
4. 在 Secrets 中设置环境变量
5. 部署

---

## 🧪 测试

### 单元测试

```python
# test_app.py (示例)
import pytest
from app import extract_text_from_pdf, parse_quiz_data

def test_parse_quiz_data():
    quiz_text = """Question 1: Test
a) Option A
b) Option B
Answer: a) Option A"""
    
    result = parse_quiz_data(quiz_text)
    assert len(result) == 1
    assert result[0]['answer_key'] == 'a'
```

### 集成测试

```bash
# 运行测试套件
pytest tests/

# 覆盖率测试
pytest --cov=. tests/
```

---

## 📊 性能优化

### 缓存策略

```python
# 使用 Streamlit 缓存
@st.cache_data
def load_data():
    # 缓存数据加载
    return data

@st.cache_resource
def init_llm():
    # 缓存资源初始化
    return ChatOpenAI(...)
```

### 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_sessions_created ON sessions(created_at);
CREATE INDEX idx_generations_session ON generations(session_id);
CREATE INDEX idx_quiz_session ON quiz_results(session_id);
```

---

## 📝 开发规范

### 代码风格

```bash
# 使用 black 格式化
pip install black
black app.py

# 使用 flake8 检查
pip install flake8
flake8 app.py
```

### 文档字符串

```python
def function_name(param1: str, param2: int) -> bool:
    """
    简短描述
    
    Args:
        param1: 参数1说明
        param2: 参数2说明
        
    Returns:
        bool: 返回值说明
        
    Raises:
        ValueError: 异常说明
    """
    pass
```

---

## 🔒 安全建议

### 生产环境清单

- [ ] 修改默认管理员密码
- [ ] 使用强密码（8+ 字符，混合大小写、数字、符号）
- [ ] 不要提交 .env 文件到版本控制
- [ ] 定期备份数据库
- [ ] 限制 Admin Dashboard 访问
- [ ] 使用 HTTPS（生产部署）
- [ ] 定期更新依赖包
- [ ] 监控 API 使用量和成本

---

## 📞 技术支持

### 资源

- **用户指南**: `用户指南.md`
- **英文版**: `USER_GUIDE_EN.md` / `TECHNICAL_GUIDE_EN.md`
- **API 文档**: LangChain / Streamlit / OpenAI 官方文档

### 贡献

欢迎提交 Issue 和 Pull Request！

---

**版本**: 1.0  
**最后更新**: 2025年10月19日  
**维护**: Study Assistant 开发团队
